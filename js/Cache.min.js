(function(window){var Cache={};_error_message="";_dataBase=null;_setting={error_split:"\n",sqlite_dbname:"mydb",sqlite_table:"my_local_cache",sqlite_db_size:2*1024*1024};extend=function(obj1,obj2){if(!(obj1 instanceof Object)){obj1=eval("("+obj1+")")}if(!(obj2 instanceof Object)){obj2=eval("("+obj2+")")}for(var index in obj2){obj1[index]=obj2[index]}return obj1};trim=function(str){var reg=new RegExp(/^\s*/);str=str.replace(reg,"");reg=new RegExp(/\s*$/);return str.replace(reg,"")};create_db=function(dbname,size){_dataBase=openDatabase(dbname,"1.0","",size);if(!_dataBase){set_error("数据库创建失败！");return false}return true};exec=function(sql,param,callback){if(!param){param=[]}else{if(typeof param=="function"){callback=param;param=[]}}query(sql,param,function(result){if(typeof callback=="function"){callback(result.rowsAffected)}})};query=function(sql,param,callback){if(!param){param=[]}else{if(typeof param=="function"){callback=param;param=[]}}_dataBase.transaction(function(tx){tx.executeSql(sql,param,function(tx,result){if(typeof callback=="function"){callback(result)}else{return result}},function(tx,e){set_error("sql error: "+e.message)})})};add_data=function(tablename,data,callback){var fields=[];var values=[];var values_sign=[];for(var i in data){fields.push(i);values.push(data[i]);values_sign.push("?")}var sql="insert into "+tablename+" ("+fields.join(",")+") values ("+values_sign.join(",")+")";query(sql,values,function(result){if(typeof callback=="function"){callback(result.insertId)}})};update_data=function(table,data,where,param,callback){if(!param){param=[]}else{if(typeof param=="function"){callback=param;param=[]}}var set_info=mk_where(data);for(var i=set_info.param.length-1;i>=0;i--){param.unshift(set_info.param[i])}var sql="UPDATE "+table+" SET "+set_info.sql;if(where){sql+=" WHERE "+where}query(sql,param,function(result){if(typeof callback=="function"){callback(result.rowsAffected)}})};delete_data=function(table,where,param,callback){if(!param){param=[]}else{if(typeof param=="function"){callback=param;param=[]}}var sql="DELETE FROM "+table+" WHERE "+where;query(sql,param,function(result){if(typeof callback=="function"){callback(result.rowsAffected)}})};fetch_data=function(sql,param,callback){if(!param){param=[]}else{if(typeof param=="function"){callback=param;param=[]}}query(sql,param,function(result){if(typeof callback=="function"){var out=[];if(result.rows.length){for(var i=0;i<result.rows.length;i++){out.push(result.rows.item(i))}}callback(out)}})};mk_where=function(data){var arr=[];var param=[];if(typeof data==="object"){for(var i in data){arr.push(i+"=?");param.push(data[i])}}return{sql:arr.join(" AND "),param:param}};set_error=function(msg){_error_message+=msg+_setting.error_split};Cache.init=function(setting){if(typeof setting=="undefined"){setting={}}_setting=extend(_setting,setting)};Cache.getError=function(){return _error_message};Cache.set=function(c_name,data){create_db(_setting.sqlite_dbname,_setting.sqlite_db_size);if(this.getError()!=""){return null}exec("create table if not exists "+_setting.sqlite_table+" (m_id INTEGER PRIMARY KEY,m_key text,m_value text)");if(data instanceof Object){data=JSON.stringify(data)}fetch_data("select count(m_id) as 'c' from "+_setting.sqlite_table+" where m_key=?",[c_name],function(dd){if(dd[0].c==0){add_data(_setting.sqlite_table,{m_id:null,m_key:c_name,m_value:data})}else{update_data(_setting.sqlite_table,{m_value:data},"m_key=?",[c_name],function(d){console.log(d)})}})};Cache.get=function(c_name,callback){create_db(_setting.sqlite_dbname,_setting.sqlite_db_size);if(Cache.getError()!=""){return null}fetch_data("select m_value from "+_setting.sqlite_table+" where m_key=?",[c_name],function(res){var r=null;for(var x in res){r=res[x].m_value;break}callback(r)})};window.Cache=Cache})(window);